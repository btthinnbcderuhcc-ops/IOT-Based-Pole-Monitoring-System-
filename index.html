<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Power Quality Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial;
  padding:20px;
}
h2,h3 { text-align:center; }
.card {
  background:#1e293b;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}
.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap:15px;
}
table {
  width:100%;
  border-collapse:collapse;
}
th,td {
  border-bottom:1px solid #334155;
  padding:8px;
  text-align:center;
}
.fault { color:#f87171; font-weight:bold; }
</style>
</head>

<body>

<h2>âš¡ Power Quality Monitoring Dashboard</h2>

<!-- LIVE DATA -->
<div class="card" id="liveData">Loading...</div>

<!-- CHARTS -->
<div class="grid">
  <div class="card"><canvas id="voltageChart"></canvas></div>
  <div class="card"><canvas id="currentChart"></canvas></div>
  <div class="card"><canvas id="pfChart"></canvas></div>
</div>

<!-- FAULT TABLE -->
<div class="card">
<h3>ðŸš¨ Fault History</h3>
<table>
<thead>
<tr>
<th>Time</th>
<th>Reason</th>
<th>Voltage</th>
<th>Current</th>
</tr>
</thead>
<tbody id="faultTable"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFTCrxgzaKrKbqIt7OLBCaqKMpfNmCOMw",
  authDomain: "iot-pole-monitoring.firebaseapp.com",
  databaseURL: "https://iot-pole-monitoring-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "iot-pole-monitoring"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ----- CHART INIT -----
function createChart(id, label) {
  return new Chart(document.getElementById(id), {
    type:'line',
    data:{ labels:[], datasets:[{ label:label, data:[], borderWidth:2 }] }
  });
}

const vChart = createChart("voltageChart","Voltage (V)");
const iChart = createChart("currentChart","Current (A)");
const pfChart = createChart("pfChart","Power Factor");

// ----- LIVE DATA -----
onValue(ref(db,'powerData'), snap => {
  const d = snap.val();

  document.getElementById("liveData").innerHTML = `
  <b>Voltage:</b> ${d.voltage} V |
  <b>Current:</b> ${d.current} A |
  <b>PF:</b> ${d.pf} |
  <b>Updated:</b> ${d.timestamp}
  `;

  updateChart(vChart, d.timestamp, d.voltage);
  updateChart(iChart, d.timestamp, d.current);
  updateChart(pfChart, d.timestamp, d.pf);
});

function updateChart(chart, label, value) {
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(value);
  if (chart.data.labels.length > 15) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

// ----- FAULT TABLE -----
onValue(ref(db,'faultLog'), snap => {
  let html = "";
  snap.forEach(c => {
    const f = c.val();
    html = `
    <tr>
      <td>${f.time}</td>
      <td class="fault">${f.reason}</td>
      <td>${f.voltage}</td>
      <td>${f.current}</td>
    </tr>` + html;
  });
  document.getElementById("faultTable").innerHTML = html;
});
</script>

</body>
</html>
